---
toc: true
title: Traffic Incident Reporter
layout: post
permalink: /hazard/
nav: true
---

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  .access-control-overlay {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 60vh;
  }
  .access-control-card {
    text-align: center;
    padding: 48px;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 24px;
    border: 1px solid #334155;
    max-width: 450px;
  }
  .access-control-card h2 {
    color: #f1f5f9;
    margin-bottom: 16px;
  }
  .access-control-card p {
    color: #94a3b8;
    margin-bottom: 12px;
  }
  .access-control-card .tier-info {
    color: #22c55e;
    font-weight: 600;
  }
  .lock-icon {
    font-size: 64px;
    margin-bottom: 16px;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #334155;
    border-top-color: #0066cc;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .access-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 24px;
  }
  .upgrade-btn {
    padding: 14px 28px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s;
  }
  .upgrade-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
  }
  .back-btn {
    padding: 14px 28px;
    background: #334155;
    color: #f1f5f9;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s;
  }
  .back-btn:hover {
    background: #475569;
  }

  /* Map and Layout Styles */
  #hazardMap {
    height: 500px;
    width: 100%;
    border-radius: 16px;
    border: 2px solid #e2e8f0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 24px;
  }

  .map-instructions {
    background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .map-instructions .icon {
    font-size: 24px;
  }

  .hazard-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 24px;
    max-width: 1200px;
    margin: 0 auto;
  }

  @media (max-width: 900px) {
    .hazard-layout {
      grid-template-columns: 1fr;
    }
  }

  .map-section {
    min-width: 0;
  }

  .form-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid #e2e8f0;
    height: fit-content;
  }

  .form-section h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #0066cc;
    font-size: 20px;
  }

  .report-container {
    max-width: 100%;
    margin: 0;
    background: transparent;
    padding: 0;
    border-radius: 0;
    box-shadow: none;
  }

  .report-container .title {
    display: none;
  }

  input, textarea, select {
    width: 100%;
    margin: 8px 0;
    padding: 12px 14px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    font-family: inherit;
    background: #f8fafc;
    transition: all 0.2s;
    box-sizing: border-box;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #0066cc;
    background: white;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  button[type="submit"] {
    width: 100%;
    background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    margin-top: 12px;
    transition: all 0.3s;
  }

  button[type="submit"]:hover {
    background: linear-gradient(135deg, #0052a3 0%, #004080 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
  }

  .form-feedback {
    margin-top: 12px;
    padding: 10px;
    border-radius: 8px;
    font-size: 14px;
  }

  .form-feedback.error {
    background: #fef2f2;
    color: #dc2626;
  }

  .form-feedback.success {
    background: #f0fdf4;
    color: #16a34a;
  }

  .selected-location {
    background: #f0f9ff;
    border: 1px solid #0066cc;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    font-size: 14px;
  }

  .selected-location .label {
    color: #0066cc;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .selected-location .address {
    color: #1e293b;
    margin-top: 4px;
  }

  .legend {
    background: white;
    padding: 12px 16px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: 16px;
  }

  .legend h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #64748b;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 6px 0;
    font-size: 13px;
  }

  .legend-marker {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }

  .legend-marker.accident { background: #ef4444; }
  .legend-marker.construction { background: #f59e0b; }
  .legend-marker.closure { background: #8b5cf6; }
  .legend-marker.other { background: #6b7280; }

  /* Custom marker styles */
  .hazard-marker {
    background: #ef4444;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  .leaflet-popup-content {
    margin: 12px 16px;
  }

  .popup-title {
    font-weight: 700;
    font-size: 15px;
    color: #1e293b;
    margin-bottom: 4px;
  }

  .popup-location {
    color: #64748b;
    font-size: 13px;
    margin-bottom: 8px;
  }

  .popup-details {
    color: #475569;
    font-size: 13px;
    border-top: 1px solid #e2e8f0;
    padding-top: 8px;
    margin-top: 8px;
  }

  .popup-type {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .popup-type.accident { background: #fef2f2; color: #dc2626; }
  .popup-type.construction { background: #fffbeb; color: #d97706; }
  .popup-type.closure { background: #f5f3ff; color: #7c3aed; }
  .popup-type.other { background: #f3f4f6; color: #4b5563; }
</style>

<!-- Access Control: Loading/Denied States -->
<div id="access-loading" class="access-control-overlay">
  <div class="access-control-card">
    <div class="spinner"></div>
    <p>Checking subscription...</p>
  </div>
</div>

<div id="access-denied" class="access-control-overlay" style="display: none;">
  <div class="access-control-card">
    <div class="lock-icon">üîí</div>
    <h2>Premium Feature</h2>
    <p>Traffic Incident Reporter is available for <strong>Plus</strong> and <strong>Pro</strong> members.</p>
    <p class="tier-info">Upgrade to unlock this feature and more!</p>
    <div class="access-buttons">
      <a href="{{site.baseurl}}/pricing" class="upgrade-btn">Upgrade Now</a>
      <a href="{{site.baseurl}}/" class="back-btn">Go Home</a>
    </div>
  </div>
</div>

<!-- Main Content (hidden until access verified) -->
<div id="main-content" style="display: none;">

<h2 style="text-align: center; margin-bottom: 8px;">üö¶ Traffic Incident Reporter</h2>
<p style="text-align: center; color: #64748b; margin-bottom: 24px;">Click on the map to report incidents or view existing hazards</p>

<div class="map-instructions">
  <span class="icon">üìç</span>
  <span><strong>Click anywhere on the map</strong> to select a location for your incident report. Existing incidents are shown as markers.</span>
</div>

<div class="hazard-layout">
  <div class="map-section">
    <div id="hazardMap"></div>
    
    <div class="legend">
      <h4>Incident Types</h4>
      <div class="legend-item">
        <span class="legend-marker accident">üöó</span>
        <span>Accident</span>
      </div>
      <div class="legend-item">
        <span class="legend-marker construction">üöß</span>
        <span>Construction / Roadwork</span>
      </div>
      <div class="legend-item">
        <span class="legend-marker closure">‚õî</span>
        <span>Road Closure</span>
      </div>
      <div class="legend-item">
        <span class="legend-marker other">‚ö†Ô∏è</span>
        <span>Other Hazard</span>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h3>üìù Report New Incident</h3>
    
    <div id="selectedLocation" class="selected-location" style="display: none;">
      <div class="label">Selected Location</div>
      <div class="address" id="selectedAddress">-</div>
    </div>

    <div class="report-container">
      <form id="incidentForm">
        <input type="hidden" id="latitude" />
        <input type="hidden" id="longitude" />
        <input type="text" id="location" placeholder="Street or Intersection (or click map)" required>
        
        <select id="type" required>
          <option value="">Select Incident Type</option>
          <option value="Accident">üöó Accident</option>
          <option value="Construction">üöß Construction / Roadwork</option>
          <option value="Road Closure">‚õî Road Closure</option>
          <option value="Pothole">üï≥Ô∏è Pothole</option>
          <option value="Flooding">üåä Flooding</option>
          <option value="Debris">ü™® Debris on Road</option>
          <option value="Other">‚ö†Ô∏è Other Hazard</option>
        </select>
        
        <textarea id="details" placeholder="Additional details (optional)..." rows="3"></textarea>
        <button type="submit">Submit Incident Report</button>
        <div class="form-feedback" id="formFeedback"></div>
      </form>
    </div>
  </div>
</div>

</div><!-- End main-content -->

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { pythonURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';

// Make map globally accessible
let hazardMap = null;
let selectedMarker = null;
let incidentMarkers = [];

// San Diego / Poway area center
const DEFAULT_CENTER = [32.9595, -117.0335];
const DEFAULT_ZOOM = 12;

// Initialize the map
function initMap() {
  hazardMap = L.map('hazardMap').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
  window.hazardMap = hazardMap;
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(hazardMap);

  // Click handler for selecting location
  hazardMap.on('click', async (e) => {
    const { lat, lng } = e.latlng;
    
    // Remove previous selection marker
    if (selectedMarker) {
      hazardMap.removeLayer(selectedMarker);
    }
    
    // Add new selection marker (blue for selected location)
    selectedMarker = L.marker([lat, lng], {
      icon: L.divIcon({
        className: 'selection-marker',
        html: '<div style="background: #0066cc; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      })
    }).addTo(hazardMap);
    
    // Store coordinates
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    
    // Reverse geocode to get address
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
      const data = await response.json();
      
      const address = data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      const shortAddress = data.address ? 
        [data.address.road, data.address.neighbourhood, data.address.city].filter(Boolean).join(', ') : 
        address;
      
      document.getElementById('location').value = shortAddress;
      document.getElementById('selectedAddress').textContent = shortAddress;
      document.getElementById('selectedLocation').style.display = 'block';
    } catch (err) {
      document.getElementById('location').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      document.getElementById('selectedAddress').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
      document.getElementById('selectedLocation').style.display = 'block';
    }
  });
  
  // Load existing incidents
  loadIncidents();
}

// Get marker icon based on incident type
function getMarkerIcon(type) {
  const typeColors = {
    'accident': { bg: '#ef4444', emoji: 'üöó' },
    'construction': { bg: '#f59e0b', emoji: 'üöß' },
    'road closure': { bg: '#8b5cf6', emoji: '‚õî' },
    'pothole': { bg: '#6366f1', emoji: 'üï≥Ô∏è' },
    'flooding': { bg: '#0ea5e9', emoji: 'üåä' },
    'debris': { bg: '#78716c', emoji: 'ü™®' },
    'other': { bg: '#6b7280', emoji: '‚ö†Ô∏è' }
  };
  
  const config = typeColors[type.toLowerCase()] || typeColors['other'];
  
  return L.divIcon({
    className: 'hazard-div-icon',
    html: `<div style="background: ${config.bg}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px;">${config.emoji}</div>`,
    iconSize: [32, 32],
    iconAnchor: [16, 16],
    popupAnchor: [0, -16]
  });
}

// Get popup type class
function getTypeClass(type) {
  const typeMap = {
    'accident': 'accident',
    'construction': 'construction',
    'road closure': 'closure',
    'roadwork': 'construction'
  };
  return typeMap[type.toLowerCase()] || 'other';
}

// Load and display incidents on map
async function loadIncidents() {
  // Clear existing markers
  incidentMarkers.forEach(marker => hazardMap.removeLayer(marker));
  incidentMarkers = [];
  
  try {
    const res = await fetch(`${pythonURI}/api/incidents`, fetchOptions);
    const data = await res.json();
    
    if (Array.isArray(data) && data.length > 0) {
      // Geocode and add each incident to map
      for (const incident of data) {
        await addIncidentMarker(incident);
      }
    }
  } catch (err) {
    console.error('Error loading incidents:', err);
  }
}

// Geocode location and add marker
async function addIncidentMarker(incident) {
  try {
    // Try to geocode the location
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(incident.location)}&limit=1`);
    const data = await response.json();
    
    if (data && data.length > 0) {
      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      
      const marker = L.marker([lat, lon], {
        icon: getMarkerIcon(incident.type)
      }).addTo(hazardMap);
      
      // Create popup content
      const popupContent = `
        <div class="popup-title">${incident.type}</div>
        <div class="popup-location">üìç ${incident.location}</div>
        ${incident.details ? `<div class="popup-details">${incident.details}</div>` : ''}
      `;
      
      marker.bindPopup(popupContent);
      incidentMarkers.push(marker);
    }
  } catch (err) {
    console.error('Geocoding error for:', incident.location, err);
  }
}

// Form submission handler
document.getElementById('incidentForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const location = document.getElementById('location').value.trim();
  const type = document.getElementById('type').value.trim();
  const details = document.getElementById('details').value.trim();
  const feedback = document.getElementById('formFeedback');

  feedback.textContent = '';
  feedback.className = 'form-feedback';

  if (!location || !type) {
    feedback.textContent = "Please select a location on the map and incident type.";
    feedback.className = 'form-feedback error';
    return;
  }

  try {
    const res = await fetch(`${pythonURI}/api/incidents`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ location, type, details })
    });

    const data = await res.json();

    if (!res.ok) {
      feedback.textContent = data.error || "Something went wrong.";
      feedback.className = 'form-feedback error';
    } else {
      feedback.textContent = "‚úì Incident reported successfully!";
      feedback.className = 'form-feedback success';
      document.getElementById('incidentForm').reset();
      document.getElementById('selectedLocation').style.display = 'none';
      
      // Remove selection marker
      if (selectedMarker) {
        hazardMap.removeLayer(selectedMarker);
        selectedMarker = null;
      }
      
      // Reload incidents to show new one
      loadIncidents();
    }
  } catch (err) {
    feedback.textContent = "Server error. Please try again.";
    feedback.className = 'form-feedback error';
  }
});

// Initialize map when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMap);
} else {
  initMap();
}
</script>

<!-- Subscription Access Check -->
<script type="module">
  import { pythonURI, fetchOptions } from '{{site.baseurl}}/assets/js/api/config.js';
  
  async function checkAccess() {
    try {
      // Check if user is logged in
      const userResponse = await fetch(`${pythonURI}/api/user`, fetchOptions);
      if (!userResponse.ok) {
        window.location.href = '{{site.baseurl}}/login';
        return;
      }
      
      const user = await userResponse.json();
      
      // Admins have full access
      if (user.role === 'Admin') {
        showContent();
        return;
      }
      
      // Check subscription
      const subResponse = await fetch(`${pythonURI}/api/subscription`, fetchOptions);
      if (subResponse.ok) {
        const subscription = await subResponse.json();
        if (subscription.tier === 'plus' || subscription.tier === 'pro') {
          showContent();
          return;
        }
      }
      
      // Free tier - show access denied
      showAccessDenied();
      
    } catch (error) {
      console.error('Access check error:', error);
      showAccessDenied();
    }
  }
  
  function showContent() {
    document.getElementById('access-loading').style.display = 'none';
    document.getElementById('access-denied').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    
    // Fix Leaflet map rendering after container becomes visible
    setTimeout(() => {
      if (window.hazardMap) {
        window.hazardMap.invalidateSize();
      }
    }, 100);
  }
  
  function showAccessDenied() {
    document.getElementById('access-loading').style.display = 'none';
    document.getElementById('access-denied').style.display = 'flex';
    document.getElementById('main-content').style.display = 'none';
  }
  
  checkAccess();
</script>